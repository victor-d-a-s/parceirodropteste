<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Parceiro Drop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #111827; color: #e5e7eb; padding-bottom: 90px; }
        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-action { background-color: #FBBF24; color: black; font-weight: bold; transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }
        .btn-action:disabled { background-color: #4B5563; color: #9CA3AF; cursor: not-allowed; }
        
        .dark-card { background-color: #1F2937; border: 1px solid #374151; border-radius: 12px; }
        .input-dark { background-color: #111827; border: 1px solid #4b5563; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; transition: 0.3s; }
        .input-dark:focus { border-color: #FBBF24; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(31,41,55,0.95); backdrop-filter: blur(10px); border-top: 1px solid #374151; display: flex; justify-content: space-around; padding: 12px 0; z-index: 50; max-width: 28rem; margin: 0 auto; }
        @media (min-width: 768px) { .bottom-nav { border-radius: 0 0 1.5rem 1.5rem; } }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #9CA3AF; flex: 1; cursor: pointer; }
        .nav-item.active { color: #FBBF24; font-weight: bold; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }

        .app-container { width: 100%; min-height: 100vh; padding-bottom: 80px; }
        @media (min-width: 768px) { .app-container { max-width: 28rem; margin: 0 auto; border-radius: 1.5rem; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); background-color: #111827; position: relative; height: 90vh; overflow-y: auto; } body { display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: #000; } }

        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: #FBBF24; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="global-loading" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100]">
        <div class="spinner w-10 h-10 border-4 mb-4"></div>
        <p class="text-gray-400 text-sm font-bold">Carregando...</p>
    </div>

    <script>
        const SUPABASE_URL = 'https://ofpnnijkhgsjarixoyhg.supabase.co'.trim(); 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJvZnBubmlqa2hnc2phcml4b3loZyIsImJvbGUiOiJhbm9uIiwiaWF0IjoxNzY1MDY1Mjc2LCJleHAiOjIwODA2NDEyNzZ9.dNOIIETmTz3l1HvhuT-ihAiymJqiaYZnklzzBzDGCFU'.trim();
        
        let sbClient = null;
        try { sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error(e); }

        let userSession = null;
        let corridaAtual = null;

        window.onload = async function() {
            const globalLoad = document.getElementById('global-loading');
            try {
                if(!sbClient) throw new Error("Erro DB");
                const { data: { session } } = await sbClient.auth.getSession();
                if (session) {
                    userSession = session;
                    await verificarAprovacao();
                } else {
                    showScreen('welcome');
                }
            } catch(e) { showScreen('welcome'); } 
            finally { if(globalLoad) globalLoad.style.display = 'none'; }
        };

        async function verificarAprovacao() {
            const { data } = await sbClient.from('motoboys').select('*').eq('id', userSession.user.id).single();
            if (data && data.status === 'Aprovado') {
                verificarStatus();
            } else {
                showScreen('pending');
            }
        }
    </script>
        <!-- TELAS (LOGIN, CADASTRO, PENDENTE) IGUAIS AO ANTERIOR -->
    <div id="screen-welcome" class="hidden app-container p-8 flex flex-col justify-center text-center fade-in w-full max-w-md">
        <div class="mb-8"><div class="inline-block p-4 rounded-full bg-yellow-500 text-black mb-4"><i class="fas fa-motorcycle text-4xl"></i></div><h1 class="text-3xl font-bold text-white mb-1">Parceiro Drop</h1><p class="text-gray-400 text-sm">Entregas Rápidas</p></div>
        <div class="space-y-4"><input type="email" id="log-email" class="input-dark text-center" placeholder="E-mail"><input type="password" id="log-senha" class="input-dark text-center" placeholder="Senha"><button onclick="fazerLogin()" id="btn-login" class="w-full btn-action py-4 rounded-xl shadow-lg">ENTRAR</button><p onclick="showScreen('cadastro')" class="text-gray-500 text-xs mt-4 cursor-pointer underline">Quero me cadastrar</p></div>
    </div>

    <!-- TELA 2: MURAL (FEED) -->
    <div id="screen-feed" class="hidden app-container p-4 fade-in">
        <div class="flex justify-between items-center mb-6 pt-2">
            <div><h1 class="text-lg font-bold text-white">Disponíveis <span class="text-green-500 text-xs">● Online</span></h1></div>
            <button onclick="sbClient.auth.signOut(); location.reload()" class="text-xs text-gray-500 border border-gray-700 px-3 py-1 rounded-full">Sair</button>
        </div>
        <div id="lista-pedidos-feed" class="space-y-3 pb-20"></div>
    </div>

    <!-- TELA 3: CORRIDA ATIVA -->
    <div id="screen-active" class="hidden app-container p-4 fade-in bg-gray-900">
        <div class="text-center mb-6 pt-6">
            <div class="inline-block bg-green-500/20 text-green-400 px-4 py-1 rounded-full text-xs font-bold mb-2 animate-pulse">EM ROTA</div>
            <h2 class="text-3xl font-bold text-white" id="active-valor">R$ 0,00</h2>
        </div>
        <div class="dark-card p-4 mb-3 border-l-4 border-blue-500">
            <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">RETIRADA</p>
            <p class="text-white font-bold" id="active-origem">...</p>
        </div>
        <div class="dark-card p-4 mb-6 border-l-4 border-green-500">
            <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">ENTREGA (CLIENTE)</p>
            <p class="text-white font-bold" id="active-cliente">...</p>
            <p class="text-gray-400 text-sm mb-3" id="active-destino">...</p>
            <a id="btn-zap-cli" href="#" target="_blank" class="block w-full bg-green-600 text-white text-center py-2 rounded-lg font-bold"><i class="fab fa-whatsapp"></i> Chamar no Zap</a>
        </div>
        <div class="dark-card p-5 border border-yellow-500/30">
            <p class="text-xs text-gray-300 text-center mb-2">Peça o PIN ao cliente:</p>
            <div class="flex gap-2">
                <input type="tel" id="input-pin" class="flex-1 bg-black border border-gray-600 text-white text-center text-2xl font-mono rounded-xl p-3 tracking-widest" placeholder="0000" maxlength="4">
                <button onclick="finalizarCorrida()" class="bg-yellow-500 text-black font-bold px-6 rounded-xl">OK</button>
            </div>
        </div>
    </div>

    <div id="bottom-menu" class="hidden bottom-nav max-w-md"><div class="nav-item active" onclick="showScreen('feed')"><i class="fas fa-list-ul"></i><span>Mural</span></div><div class="nav-item" onclick="verificarStatus()"><i class="fas fa-motorcycle"></i><span>Rota</span></div></div>

    <script>
        $(document).ready(function(){ $('#cad-cpf').mask('000.000.000-00'); $('#cad-zap').mask('(00) 00000-0000'); });

        function showScreen(id) {
            ['welcome', 'feed', 'active', 'pending'].forEach(s => document.getElementById('screen-'+s).classList.add('hidden'));
            document.getElementById('screen-'+id).classList.remove('hidden');
            if(id === 'feed' || id === 'active') { document.getElementById('bottom-menu').classList.remove('hidden'); document.getElementById('bottom-menu').classList.add('flex'); }
            else { document.getElementById('bottom-menu').classList.add('hidden'); }
        }

        async function fazerLogin() {
            const email = document.getElementById('log-email').value; const senha = document.getElementById('log-senha').value; const btn = document.getElementById('btn-login');
            btn.innerText = "..."; btn.disabled = true;
            const { data, error } = await sbClient.auth.signInWithPassword({ email, password: senha });
            if (error) { alert("Erro: " + error.message); btn.innerText = "ENTRAR"; btn.disabled = false; }
            else { userSession = data.session; verificarAprovacao(); }
        }
                // --- SISTEMA DE PEDIDOS ---
        async function verificarStatus() {
            const { data } = await sbClient.from('pedidos').select('*').eq('motoboy_id', userSession.user.id).eq('status', 'Em Rota').single();
            if(data) { corridaAtual = data; montarTelaAtiva(data); showScreen('active'); } 
            else { atualizarFeed(); showScreen('feed'); }
        }

        async function atualizarFeed() {
            const div = document.getElementById('lista-pedidos-feed');
            div.innerHTML = '<div class="text-center mt-10"><div class="spinner mx-auto"></div></div>';
            
            const { data } = await sbClient.from('pedidos').select('*').eq('status', 'Solicitado').order('created_at', {ascending:false});
            div.innerHTML = '';

            if(!data || data.length === 0) { div.innerHTML = '<div class="text-center mt-20 opacity-50"><p>Sem corridas.</p></div>'; return; }

            data.forEach(p => {
                div.innerHTML += `
                    <div class="dark-card p-4 mb-3 border-l-4 border-yellow-500 relative">
                        <div class="absolute top-4 right-4 bg-green-600 text-white font-bold px-2 py-1 rounded text-sm">R$ ${p.valor_frete}</div>
                        <p class="text-xs text-gray-500 font-bold mb-1">RETIRADA</p>
                        <p class="text-white font-bold text-sm mb-2 truncate">${p.origem}</p>
                        <p class="text-xs text-gray-500 font-bold mb-1">ENTREGA</p>
                        <p class="text-white text-sm truncate mb-3">${p.destino}</p>
                        <button onclick="aceitarCorrida(${p.id})" class="w-full bg-yellow-500 text-black font-bold py-2 rounded">ACEITAR</button>
                    </div>
                `;
            });
        }
        
        async function aceitarCorrida(id) {
            if(!confirm("Aceitar corrida?")) return;
            const { error } = await sbClient.from('pedidos').update({ status: 'Em Rota', motoboy_id: userSession.user.id }).eq('id', id).eq('status', 'Solicitado');
            if(error) alert("Já foi pega!"); else verificarStatus();
        }

        function montarTelaAtiva(p) {
            document.getElementById('active-valor').innerText = "R$ " + p.valor_frete;
            document.getElementById('active-origem').innerText = p.origem;
            document.getElementById('active-destino').innerText = p.destino;
            document.getElementById('active-cliente').innerText = p.nome_destinatario || "Cliente";
            if(p.telefone_destinatario) document.getElementById('btn-zap-cli').href = `https://wa.me/55${p.telefone_destinatario.replace(/\D/g,'')}`;
        }

        async function finalizarCorrida() {
            const pin = document.getElementById('input-pin').value;
            if(pin !== corridaAtual.pin_entrega) return alert("PIN Incorreto.");
            await sbClient.from('pedidos').update({ status: 'Finalizado' }).eq('id', corridaAtual.id);
            alert("Finalizada!"); location.reload();
        }
        
        setInterval(() => { if(!document.getElementById('screen-feed').classList.contains('hidden')) atualizarFeed(); }, 5000);
    </script>
</body>
</html>
